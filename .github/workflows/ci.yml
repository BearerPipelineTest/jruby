name: JRuby CI

on: [push, pull_request]

env:
  JAVA_OPTS: '-XX:+TieredCompilation -XX:TieredStopAtLevel=1 -Xms60M -Xmx720M -XX:InitialCodeCacheSize=40M -XX:ReservedCodeCacheSize=120M'

jobs:
  # Maven test suites that pass on both Java 8 and 11
  maven-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11']
        maven-target: ['main', 'dist', 'complete', 'osgi', 'test']
      fail-fast: false

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: main profile
        run: tool/maven-ci-script.sh
        env:
          PHASE: 'package -P${{ matrix.maven-target }}'
  #      - name: main extended
  #        run: tool/maven-ci-script.sh
  #        env:
  #          PHASE: 'package -Pmain,test -Dinvoker.test=extended'

  # Maven test suites that don't pass on Java 11
  maven-test-8:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java 8
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '8'
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: jruby-jars profile
        run: tool/maven-ci-script.sh
        env:
          PHASE: 'package -Pjruby-jars'
      - name: jruby-jars extended
        run: tool/maven-ci-script.sh
        env:
          PHASE: 'package -Pjruby-jars,test -Dinvoker.test=extended'

  dependency-check:
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java 8
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: '8'
          cache: 'maven'
      - name: dependency convergence
        run: tool/maven-ci-script.sh
        env:
          PHASE: 'install -Pmain -Dinvoker.test=GH-6081*'

  mri-core-full-interp:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:mri:core:int
        run: bin/jruby -S rake test:mri:core:int

  mri-core-jit:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11', '16']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:mri:core:jit
        run: bin/jruby -S rake test:mri:core:jit

  mri-extra:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:mri:extra
        run: bin/jruby -S rake test:mri:extra

  mri-stdlib:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:mri:stdlib
        run: bin/jruby -S rake test:mri:stdlib

  spec-ruby-fast:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11', '16']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:ruby:fast
        run: bin/jruby -S rake spec:ruby:fast

  spec-ruby-fast-jit:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11', '16']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:ruby:fast:jit
        run: bin/jruby -S rake spec:ruby:fast:jit

  spec-ruby-slow:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:ruby:slow
        run: bin/jruby -S rake spec:ruby:slow
      - name: rake spec:ruby:debug
        run: bin/jruby -S rake spec:ruby:debug

  test-versions:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: maven-ci-script.sh
        run: tool/maven-ci-script.sh
        env:
          COMMAND: 'test/check_versions.sh'

  jruby_complete_jar_extended:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: maven-ci-script.sh
        run: tool/maven-ci-script.sh
        env:
          PHASE: '-Pjruby_complete_jar_extended -Dinvoker.skip=true'

  sequel:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    services:
      postgres:
        image: postgres:11.5
        ports: ["5432:5432"]
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: sequel_test
        ports: ["3306:3306"]
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: sequel
        run: tool/sequel-github-actions.sh

  concurrent-ruby:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: concurrent-ruby
        run: tool/concurrent-ruby-github-actions.sh

  jruby-tests-int:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:jruby:int
        run: bin/jruby -S rake test:jruby:int

  jruby-tests-dev:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '--dev -J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:jruby
        run: bin/jruby -S rake test:jruby

  jruby-tests-jit-indy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11', '16']
      fail-fast: false

    env:
      JRUBY_OPTS: '-Xcompile.invokedynamic -J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:jruby
        run: bin/jruby -S rake test:jruby

  jruby-tests-aot:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '--dev -J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:jruby:aot
        run: bin/jruby -S rake test:jruby:aot

  jruby-tests-slow:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '--dev -J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake test:slow_suites
        run: bin/jruby -S rake test:slow_suites

  ji-specs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11', '16']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:ji
        run: bin/jruby -S rake spec:ji

  ji-specs-indy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-Xcompile.invokedynamic -J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:ji
        run: bin/jruby -S rake spec:ji

  compiler-specs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:compiler
        run: bin/jruby -S rake spec:compiler

  compiler-specs-indy:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11', '16']
      fail-fast: false

    env:
      JRUBY_OPTS: '-Xcompile.invokedynamic -J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:compiler
        run: bin/jruby -S rake spec:compiler

  ffi-specs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8', '11']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:ffi
        run: bin/jruby -S rake spec:ffi

  regression-specs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:regression
        run: bin/jruby -S rake spec:regression

  regression-specs-jit:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-Xjit.threshold=0 -J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:regression
        run: bin/jruby -S rake spec:regression

  jruby-specs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:jruby
        run: bin/jruby -S rake spec:jruby

  jrubyc-specs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:jrubyc
        run: bin/jruby -S rake spec:jrubyc

  profiler-specs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: ['8']
      fail-fast: false

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'zulu'
          java-version: ${{ matrix.java-version }}
          cache: 'maven'
      - name: bootstrap
        run: mvn -Pbootstrap clean package
      - name: bundle install
        run: bin/jruby -S bundle install
      - name: rake spec:profiler
        run: bin/jruby -S rake spec:profiler

  openj9-jdk8-maven:
    runs-on: ubuntu-latest

    env:
      JRUBY_OPTS: '-J-Xmx1G'

    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: set up java ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt-openj9'
          java-version: '8'
          cache: 'maven'
      - name: test profile
        run: tool/maven-ci-script.sh
        env:
          PHASE: 'package -Ptest'

  publish-snapshot:
    needs: [maven-test, maven-test-8, dependency-check, mri-core-full-interp, mri-core-jit, mri-extra, mri-stdlib, spec-ruby-fast, spec-ruby-fast-jit, spec-ruby-slow, test-versions, jruby_complete_jar_extended, sequel, concurrent-ruby, jruby-tests-int, jruby-tests-dev, jruby-tests-jit-indy, jruby-tests-aot, jruby-tests-slow, ji-specs, ji-specs-indy, compiler-specs, compiler-specs-indy, ffi-specs, regression-specs, regression-specs-jit, jruby-specs, jrubyc-specs, profiler-specs, openj9-jdk8-maven]
    uses: jruby/jruby/.github/workflows/snapshot-publish.yml@a144fdb39a1e2844322d9e439d02d378593a08d4
    secrets:
      SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
      SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
